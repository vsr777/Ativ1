// graphql/server.js - Sistema DANGER ZONE API GraphQL
const { ApolloServer, gql } = require('apollo-server');
const { v4: uuidv4 } = require('uuid');

// Defini√ß√£o do Schema GraphQL
const typeDefs = gql`
  "N√≠veis de risco do perigo - impactam protocolos de seguran√ßa"
  enum RiskLevel {
    extreme
    high
    moderate
    low
  }
  
  "Categorias de perigo - determinam equipamentos de prote√ß√£o"
  enum DangerCategory {
    chemical
    electrical
    mechanical
    biological
    radiation
  }
  
  "Status do perigo no sistema"
  enum DangerStatus {
    active
    contained
    mitigated
    eliminated
  }
  
  "Registro completo de um perigo"
  type Danger {
    "Identificador √∫nico do perigo"
    id: ID!
    
    "T√≠tulo descritivo do perigo"
    title: String!
    
    "Detalhes sobre o perigo e procedimentos de preven√ß√£o"
    description: String
    
    "N√≠vel de risco classificado"
    riskLevel: RiskLevel!
    
    "Categoria do perigo"
    category: DangerCategory!
    
    "Localiza√ß√£o exata do perigo - ESTRITAMENTE CONTROLADO"
    location: String!
    
    "Classifica√ß√£o de severidade (1-10)"
    consequenceRating: Int!
    
    "Data e hora de registro inicial"
    dateReported: String!
    
    "√öltima inspe√ß√£o de seguran√ßa"
    lastInspection: String!
    
    "Operador que reportou o perigo"
    reportedBy: String!
    
    "Status atual do perigo"
    status: DangerStatus!
    
    "Equipamentos de prote√ß√£o recomendados"
    protectiveEquipment: [String]
    
    "Procedimentos de conten√ß√£o"
    containmentProcedures: [String]
  }
  
  "Estat√≠sticas do registro de perigos"
  type DangerStats {
    "Total de perigos registrados"
    totalCount: Int!
    
    "Perigos por n√≠vel de risco"
    byRiskLevel: [RiskLevelCount!]!
    
    "Perigos por categoria"
    byCategory: [CategoryCount!]!
    
    "N√≠veis cr√≠ticos - requerem aten√ß√£o imediata"
    criticalLevels: Int!
  }
  
  "Contagem por n√≠vel de risco"
  type RiskLevelCount {
    riskLevel: RiskLevel!
    count: Int!
  }
  
  "Contagem por categoria"
  type CategoryCount {
    category: DangerCategory!
    count: Int!
  }
  
  "Log de auditoria de seguran√ßa"
  type SecurityLog {
    timestamp: String!
    operation: String!
    dangerId: ID
    details: String!
    operatorLevel: Int!
  }
  
  type Query {
    "Obter todos os perigos registrados"
    dangers: [Danger!]!
    
    "Obter um perigo espec√≠fico por ID"
    danger(id: ID!): Danger
    
    "Filtra perigos por n√≠vel de risco"
    dangersByRiskLevel(level: RiskLevel!): [Danger!]!
    
    "Filtra perigos por categoria"
    dangersByCategory(category: DangerCategory!): [Danger!]!
    
    "Estat√≠sticas gerais dos perigos registrados"
    dangerStats: DangerStats!
    
    "Logs de seguran√ßa - REQUER N√çVEL DE AUTORIZA√á√ÉO 5"
    securityLogs(limit: Int): [SecurityLog!]!
  }
  
  type Mutation {
    "Registrar um novo perigo no sistema"
    createDanger(
      title: String!,
      description: String,
      riskLevel: RiskLevel!,
      category: DangerCategory!,
      location: String!,
      consequenceRating: Int!,
      protectiveEquipment: [String!],
      containmentProcedures: [String!]
    ): Danger!
    
    "Remover um registro de perigo - REQUER N√çVEL DE AUTORIZA√á√ÉO 4"
    deleteDanger(id: ID!): Boolean!
    
    "Atualizar o status de um perigo - REQUER N√çVEL DE AUTORIZA√á√ÉO 3"
    updateDangerStatus(id: ID!, status: DangerStatus!): Danger!
    
    "Registrar uma nova inspe√ß√£o"
    recordInspection(id: ID!): Danger!
  }
`;

// Armazenamento em mem√≥ria - Banco de dados simulado
let dangerRegistry = [];
let securityLogs = [];

// Fun√ß√£o para registrar logs de seguran√ßa
const logSecurityAction = (action, dangerId, details, level) => {
  const logEntry = {
    timestamp: new Date().toISOString(),
    operation: action,
    dangerId: dangerId || null,
    details: details,
    operatorLevel: level
  };
  
  securityLogs.push(logEntry);
  console.log(`[${logEntry.timestamp}] üîí LOG: ${action} - ${details} - Operador N√≠vel ${level}`);
  
  return logEntry;
};

// Fun√ß√£o de valida√ß√£o de n√≠vel de acesso
const requireSecurityLevel = (context, level, operation) => {
  if (!context.securityLevel) {
    throw new Error('üö´ ACESSO NEGADO: Credenciais de seguran√ßa n√£o fornecidas');
  }
  
  if (context.securityLevel < level) {
    throw new Error(`üö´ ACESSO NEGADO: N√≠vel ${level} requerido para ${operation}, fornecido: ${context.securityLevel}`);
  }
  
  return true;
};

// Resolvers para as queries e mutations
const resolvers = {
  Query: {
    dangers: (_, __, context) => {
      requireSecurityLevel(context, 1, 'consultar perigos');
      logSecurityAction('CONSULTA', null, 'Lista completa de perigos recuperada', context.securityLevel);
      return dangerRegistry;
    },
    
    danger: (_, { id }, context) => {
      requireSecurityLevel(context, 1, 'consultar perigo espec√≠fico');
      const danger = dangerRegistry.find(d => d.id === id);
      
      if (!danger) {
        throw new Error('‚ö†Ô∏è REGISTRO N√ÉO ENCONTRADO: ID de perigo inv√°lido ou removido');
      }
      
      logSecurityAction('CONSULTA', id, `Perigo ID: ${id} acessado`, context.securityLevel);
      return danger;
    },
    
    dangersByRiskLevel: (_, { level }, context) => {
      requireSecurityLevel(context, 1, 'consultar perigos por n√≠vel');
      
      // Perigos extremos requerem n√≠vel 2
      if (level === 'extreme') {
        requireSecurityLevel(context, 2, 'consultar perigos extremos');
      }
      
      const filtered = dangerRegistry.filter(d => d.riskLevel === level);
      logSecurityAction('CONSULTA', null, `Filtro por n√≠vel de risco: ${level} (${filtered.length} resultados)`, context.securityLevel);
      return filtered;
    },
    
    dangersByCategory: (_, { category }, context) => {
      requireSecurityLevel(context, 1, 'consultar perigos por categoria');
      
      const filtered = dangerRegistry.filter(d => d.category === category);
      logSecurityAction('CONSULTA', null, `Filtro por categoria: ${category} (${filtered.length} resultados)`, context.securityLevel);
      return filtered;
    },
    
    dangerStats: (_, __, context) => {
      requireSecurityLevel(context, 2, 'consultar estat√≠sticas');
      
      // Contagem por n√≠vel de risco
      const riskLevels = ['extreme', 'high', 'moderate', 'low'];
      const byRiskLevel = riskLevels.map(level => ({
        riskLevel: level,
        count: dangerRegistry.filter(d => d.riskLevel === level).length
      }));
      
      // Contagem por categoria
      const categories = ['chemical', 'electrical', 'mechanical', 'biological', 'radiation'];
      const byCategory = categories.map(cat => ({
        category: cat,
        count: dangerRegistry.filter(d => d.category === cat).length
      }));
      
      // Contagem de n√≠veis cr√≠ticos (extreme + high)
      const criticalLevels = dangerRegistry.filter(d => 
        d.riskLevel === 'extreme' || d.riskLevel === 'high'
      ).length;
      
      logSecurityAction('CONSULTA', null, 'Estat√≠sticas de perigos acessadas', context.securityLevel);
      
      return {
        totalCount: dangerRegistry.length,
        byRiskLevel,
        byCategory,
        criticalLevels
      };
    },
    
    securityLogs: (_, { limit }, context) => {
      // Requer alto n√≠vel de acesso
      requireSecurityLevel(context, 5, 'acessar logs de seguran√ßa');
      
      logSecurityAction('ADMIN', null, 'Logs de seguran√ßa acessados', context.securityLevel);
      
      // Retorna os logs mais recentes primeiro, limitados se especificado
      const sortedLogs = [...securityLogs].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      return limit ? sortedLogs.slice(0, limit) : sortedLogs;
    }
  },
  
  Mutation: {
    createDanger: (_, args, context) => {
      // Requer n√≠vel b√°sico para perigos comuns
      requireSecurityLevel(context, 2, 'registrar perigo');
      
      // N√≠vel extremo requer autoriza√ß√£o maior
      if (args.riskLevel === 'extreme') {
        requireSecurityLevel(context, 3, 'registrar perigo extremo');
      }
      
      // Valida√ß√£o espec√≠fica para perigos extremos
      if (args.riskLevel === 'extreme' && args.consequenceRating < 7) {
        throw new Error('‚ö†Ô∏è INCONSIST√äNCIA DE DADOS: Perigos extremos devem ter classifica√ß√£o de consequ√™ncia 7-10');
      }
      
      const newDanger = {
        id: uuidv4(),
        title: args.title,
        description: args.description || 'ALERTA: Detalhes n√£o fornecidos',
        riskLevel: args.riskLevel,
        category: args.category,
        location: args.location,
        consequenceRating: args.consequenceRating,
        dateReported: new Date().toISOString(),
        lastInspection: new Date().toISOString(),
        reportedBy: `Operador de Seguran√ßa #${context.securityLevel}`,
        status: 'active',
        protectiveEquipment: args.protectiveEquipment || [],
        containmentProcedures: args.containmentProcedures || []
      };
      
      dangerRegistry.push(newDanger);
      
      // Mensagem espec√≠fica para o log
      let alertLevel;
      switch(args.riskLevel) {
        case 'extreme': alertLevel = 'üö® CR√çTICO'; break;
        case 'high': alertLevel = '‚ö†Ô∏è GRAVE'; break;
        case 'moderate': alertLevel = '‚ö†Ô∏è MODERADO'; break;
        default: alertLevel = 'BAIXO';
      }
      
      logSecurityAction('REGISTRO', newDanger.id, 
                       `${alertLevel} - ${args.title} - Categoria: ${args.category}`, 
                       context.securityLevel);
      
      return newDanger;
    },
    
    deleteDanger: (_, { id }, context) => {
      // Requer n√≠vel elevado para remover registros
      requireSecurityLevel(context, 4, 'remover registro de perigo');
      
      const dangerIndex = dangerRegistry.findIndex(d => d.id === id);
      
      if (dangerIndex === -1) {
        throw new Error('‚ö†Ô∏è REGISTRO N√ÉO ENCONTRADO: ID de perigo inv√°lido ou j√° removido');
      }
      
      // Guarda informa√ß√µes para o log
      const dangerInfo = dangerRegistry[dangerIndex];
      
      // Perigos extremos requerem autoriza√ß√£o m√°xima
      if (dangerInfo.riskLevel === 'extreme') {
        requireSecurityLevel(context, 5, 'remover perigo extremo');
      }
      
      // Remove o perigo
      dangerRegistry.splice(dangerIndex, 1);
      
      logSecurityAction('REMO√á√ÉO', id, 
                       `Perigo removido: ${dangerInfo.title} - N√≠vel: ${dangerInfo.riskLevel}`, 
                       context.securityLevel);
      
      return true;
    },
    
    updateDangerStatus: (_, { id, status }, context) => {
      // Requer n√≠vel de acesso moderado
      requireSecurityLevel(context, 3, 'atualizar status de perigo');
      
      const dangerIndex = dangerRegistry.findIndex(d => d.id === id);
      
      if (dangerIndex === -1) {
        throw new Error('‚ö†Ô∏è REGISTRO N√ÉO ENCONTRADO: ID de perigo inv√°lido ou removido');
      }
      
      // Atualiza o status
      dangerRegistry[dangerIndex].status = status;
      
      logSecurityAction('ATUALIZA√á√ÉO', id, 
                       `Status atualizado para: ${status}`, 
                       context.securityLevel);
      
      return dangerRegistry[dangerIndex];
    },
    
    recordInspection: (_, { id }, context) => {
      // Requer n√≠vel b√°sico
      requireSecurityLevel(context, 2, 'registrar inspe√ß√£o');
      
      const dangerIndex = dangerRegistry.findIndex(d => d.id === id);
      
      if (dangerIndex === -1) {
        throw new Error('‚ö†Ô∏è REGISTRO N√ÉO ENCONTRADO: ID de perigo inv√°lido ou removido');
      }
      
      // Atualiza a data de inspe√ß√£o
      dangerRegistry[dangerIndex].lastInspection = new Date().toISOString();
      
      logSecurityAction('INSPE√á√ÉO', id, 
                       `Inspe√ß√£o registrada para perigo: ${dangerRegistry[dangerIndex].title}`, 
                       context.securityLevel);
      
      return dangerRegistry[dangerIndex];
    }
  }
};

// Inicializar o servidor Apollo
const server = new ApolloServer({
  typeDefs,
  resolvers,
  context: ({ req }) => {
    // Extrai o n√≠vel de seguran√ßa do cabe√ßalho
    const securityHeader = req.headers.authorization || '';
    
    // Formato esperado: "SecurityLevel 3"
    const securityLevel = securityHeader.startsWith('SecurityLevel ')
      ? parseInt(securityHeader.split(' ')[1], 10)
      : 0;
    
    return { securityLevel };
  },
  formatError: (err) => {
    // Personaliza as mensagens de erro
    console.error(`[${new Date().toISOString()}] ‚ùå ERRO: ${err.message}`);
    
    return {
      message: err.message,
      code: err.extensions?.code || 'DANGER_ERROR',
      timestamp: new Date().toISOString()
    };
  }
});

// Inicia o servidor
server.listen({ port: 4000 }).then(({ url }) => {
  console.log(`
  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
  ‚ïë  üö® DANGER ZONE - GRAPHQL SECURITY INTERFACE     ‚ïë
  ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
  ‚ïë  Status: ONLINE                                   ‚ïë
  ‚ïë  Interface: ${url}                              ‚ïë
  ‚ïë  Hora de ativa√ß√£o: ${new Date().toISOString()}   ‚ïë
  ‚ïë  PROTOCOLOS DE SEGURAN√áA: ATIVOS                 ‚ïë
  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
  `);
});